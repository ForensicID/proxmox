apt install -y vim apt-transport-https wget gnupg

add-apt-repository ppa:ondrej/php
apt-get install nginx php7.4 php7.4-fpm php7.4-cli php7.4-mysql php7.4-curl php7.4-json libapache2-mod-php7.4 php7.4-curl php7.4-gd php7.4-mbstring php7.4-xml php7.4-xmlrpc php7.4-soap php7.4-intl php7.4-zip php7.4-cli php7.4-mysql php7.4-common php7.4-opcache php7.4-pgsql php7.4-gmp php7.4-imagick -y

wget -O - https://packages.icinga.com/icinga.key | gpg --dearmor -o /usr/share/keyrings/icinga-archive-keyring.gpg

. /etc/os-release; if [ ! -z ${UBUNTU_CODENAME+x} ]; then DIST="${UBUNTU_CODENAME}"; else DIST="$(lsb_release -c| awk '{print $2}')"; fi;  echo "deb [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/ubuntu icinga-${DIST} main" >  /etc/apt/sources.list.d/${DIST}-icinga.list
echo "deb-src [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/ubuntu icinga-${DIST} main" >>  /etc/apt/sources.list.d/${DIST}-icinga.list

apt update
apt install icinga2 monitoring-plugins icinga2-ido-pgsql -y

sudo su postgres
psql
create database icinga2;
create user icinga2 with password 'Skills39';
grant all privileges on database icinga2 to icinga2;
\q

psql -h 127.0.0.1 -U icinga2 -d icinga2 < /usr/share/icinga2-ido-pgsql/schema/pgsql.sql
nano /etc/icinga2/features-available/ido-pgsql.conf

icinga2 feature enable ido-pgsql
systemctl restart icinga2
icinga2 api setup

nano /etc/icinga2/conf.d/api-users.conf
object ApiUser "icingaweb2" {
  password = "Skill20"
  permissions = [ "status/query", "actions/*", "objects/modify/*", "objects/query/*" ]
}

systemctl restart icinga2
apt install icingaweb2 libapache2-mod-php icingacli -y
nano /etc/php/7.4/apache2/php.ini
date.timezone = Asia/Jakarta

sudo su postgres
psql
create database icingaweb2;
create user icingaweb2 with password 'Skills39';
grant all privileges on database icingaweb2 to icingaweb2;
\q

icingacli setup token create
icingacli setup token show

http://[domain-name-or-ip-address]/icingaweb2/setup
icinga2 feature enable command
systemctl restart icinga2.service
